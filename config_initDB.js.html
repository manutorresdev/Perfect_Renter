<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>config/initDB.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Inicio</a></h2><h3>Modules</h3><ul><li><a href="module-Database.html">Database</a></li><li></li><li><a href="module-Entries.html">Entries</a><ul class='methods'><li data-type='method'><a href="module-Entries.html#~addPropertyPhoto">addPropertyPhoto</a></li><li data-type='method'><a href="module-Entries.html#~contactProperty">contactProperty</a></li><li data-type='method'><a href="module-Entries.html#~deleteProperty">deleteProperty</a></li><li data-type='method'><a href="module-Entries.html#~editProperty">editProperty</a></li></ul></li><li></li><li></li><li></li><li><a href="module-Helpers.html">Helpers</a><ul class='methods'><li data-type='method'><a href="module-Helpers.html#~authUser">authUser</a></li><li data-type='method'><a href="module-Helpers.html#~canEdit">canEdit</a></li><li data-type='method'><a href="module-Helpers.html#~deletePhoto">deletePhoto</a></li><li data-type='method'><a href="module-Helpers.html#~formatDate">formatDate</a></li><li data-type='method'><a href="module-Helpers.html#~generateRandomString">generateRandomString</a></li><li data-type='method'><a href="module-Helpers.html#~getRandomValue">getRandomValue</a></li><li data-type='method'><a href="module-Helpers.html#~savePhoto">savePhoto</a></li><li data-type='method'><a href="module-Helpers.html#~sendMail">sendMail</a></li><li data-type='method'><a href="module-Helpers.html#~userExists">userExists</a></li><li data-type='method'><a href="module-Helpers.html#~validate">validate</a></li></ul></li><li></li><li></li><li></li><li><a href="module-Routes.html">Routes</a></li><li><a href="module-Schemas.html">Schemas</a></li><li></li><li><a href="module-Users.html">Users</a><ul class='methods'><li data-type='method'><a href="module-Users.html#~contactUser">contactUser</a></li><li data-type='method'><a href="module-Users.html#~deleteUser">deleteUser</a></li><li data-type='method'><a href="module-Users.html#~editUser">editUser</a></li><li data-type='method'><a href="module-Users.html#~editUserPass">editUserPass</a></li><li data-type='method'><a href="module-Users.html#~getUser">getUser</a></li><li data-type='method'><a href="module-Users.html#~listUsers">listUsers</a></li><li data-type='method'><a href="module-Users.html#~loginUser">loginUser</a></li><li data-type='method'><a href="module-Users.html#~newUser">newUser</a></li><li data-type='method'><a href="module-Users.html#~passUserRecover">passUserRecover</a></li><li data-type='method'><a href="module-Users.html#~recoverUserPass">recoverUserPass</a></li><li data-type='method'><a href="module-Users.html#~validateUser">validateUser</a></li></ul></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li><li></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">config/initDB.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const getDB = require('./getDB');
const faker = require('faker/locale/es');
const { format } = require('date-fns');
const mail = require('@sendgrid/mail');
/**
 * @module Database
 */
/**
 * Creación base de datos
 * @name InitDataBase
 * @returns {Promise} Crea la base de datos con los datos proporcionados por la dependencia Faker.
 */
async function main() {
  let connection;

  try {
    connection = await getDB();
    //Eliminación de tablas existentes
    await connection.query('DROP TABLE IF EXISTS photos');
    await connection.query('DROP TABLE IF EXISTS votes');
    await connection.query('DROP TABLE IF EXISTS history');
    await connection.query('DROP TABLE IF EXISTS properties');
    await connection.query('DROP TABLE IF EXISTS users');

    console.log('Tablas Eliminadas');

    /* Crearemos las tablas necesarias */

    /* Creamos la tabla users */
    await connection.query(`
        CREATE TABLE users (
            idUser INT PRIMARY KEY AUTO_INCREMENT,
            name VARCHAR(100),
            lastName VARCHAR(100),
            tel VARCHAR(20),
            birthDate DATE NOT NULL,
            email VARCHAR(100) UNIQUE NOT NULL,
            password VARCHAR(512) NOT NULL,
            avatar VARCHAR(50),
            bio TEXT,
            city VARCHAR(50) NOT NULL,
            renterActive BOOLEAN DEFAULT false,
            deleted BOOLEAN DEFAULT false,
            role ENUM("admin", "renter", "tenant") DEFAULT "tenant" NOT NULL,
            registrationCode VARCHAR(100),
            recoverCode VARCHAR(100),
            createdAt DATETIME NOT NULL,
            modifiedAt DATETIME
        )
        `);

    // Creamos la tabla property  "Pisos en alquiler"
    await connection.query(`
        CREATE TABLE properties(
            idProperty INT PRIMARY KEY AUTO_INCREMENT,
            idUser INT NOT NULL,
            FOREIGN KEY (idUser) REFERENCES users(idUser) ON DELETE CASCADE,
            city VARCHAR(100),
            province VARCHAR(100),
            address VARCHAR(100),
            zipCode VARCHAR(5),
            number INT,
            type ENUM("duplex","casa","piso"),
            stair VARCHAR(50),
            flat INT,
            gate VARCHAR(20),
            mts DECIMAL(5,2),
            bedrooms INT,
            garage BOOLEAN,
            terrace BOOLEAN,
            toilets INT,
            energyCertificate BOOLEAN,
            availabilityDate DATE,
            price DECIMAL(6,2),
            estate ENUM("reservado", "alquilado", "disponible"),
            modifiedAt DATETIME,
            createdAt DATETIME NOT NULL
        )
    `);

    // Creamos la tabla votes.
    //   ---idVoted hace referencia a quien esta siendo calificado.
    //   ---idUser hace referencia a quien realiza el voto.

    await connection.query(`
        CREATE TABLE votes (
            idVote INT PRIMARY KEY AUTO_INCREMENT,
            vote TINYINT NOT NULL,
            comment VARCHAR(250),
            idVoted INT,
            FOREIGN KEY (idUser) REFERENCES users(idUser) ON DELETE CASCADE,
            idProperty INT,
            idUser INT NOT NULL,
            FOREIGN KEY (idUser) REFERENCES users(idUser),
            CONSTRAINT votes_CK1 CHECK (vote IN(1, 2, 3, 4, 5)),
            createdAt DATETIME NOT NULL
        )
    `);

    await connection.query(`
        CREATE TABLE photos (
            idPhoto INT PRIMARY KEY AUTO_INCREMENT,
            idProperty INT NOT NULL,
            FOREIGN KEY (idProperty) REFERENCES properties(idProperty) ON DELETE CASCADE,
            name VARCHAR(100),
            createdAt DATETIME NOT NULL
        )
    `);

    console.log('Tablas creadas');

    // Insertar el usuario administrador.
    await connection.query(`
    INSERT INTO users ( name, lastName, tel, email, password, role, createdAt, city, birthDate)
    VALUES (
        "david",
        "losas",
        "123456789",
        "david1935@gmail.com",
        SHA2("123456", 512),
        "admin",
        "${format(new Date(), 'yyyy-MM-dd HH:mm:ss')}",
        "A coruña",
        "1900-01-30"
    )
`);
    // Nº de usuarios que queremos introducir.
    const USERS = 10;

    // Insertamos los usuarios.
    for (let i = 0; i &lt; USERS; i++) {
      // Datos de faker.

      const name = faker.name.findName();
      const lastName = faker.name.lastName();
      const phone = faker.phone.phoneNumber();
      const email = faker.internet.email();
      const password = faker.internet.password();
      const city = faker.address.cityName();
      const birthDate = format(faker.datatype.datetime(), 'yyyy-MM-dd');

      // Fecha de cración.
      const createdAt = format(new Date(), 'yyyy-MM-dd HH:mm:ss');

      await connection.query(`
        INSERT INTO users ( name, lastName, tel, email, password, createdAt, city, birthDate)
        VALUES ( "${name}", "${lastName}", "${phone}", "${email}", "${password}", "${createdAt}", "${city}", "${birthDate}" )
    `);
    }

    console.log('Usuarios creados');
  } catch (error) {
    console.error(error.message);
  } finally {
    if (connection) connection.release();
    process.exit(0);
  }
}

main();
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Sat Sep 18 2021 00:02:13 GMT+0200 (Central European Summer Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
